# âš¡ Redis ê³ ê°€ìš©ì„± ì ìš© & íŒŒì´í”„ë¼ì¸ ì•ˆì •ì„± í™•ë³´

# ğŸ›‘ ë¬¸ì œ (Problem)

- RedisëŠ” íŒŒì´í”„ë¼ì¸ì—ì„œ **í•µì‹¬ ìºì‹œ ì €ì¥ì†Œ**ë¡œ ì‚¬ìš©
- Redis ì¥ì•  ë°œìƒ ì‹œ ì˜í–¥:

### Collector ì¸¡
- ìºì‹œ ì €ì¥ ì‹¤íŒ¨ â†’ íŒŒì´í”„ë¼ì¸ ë¹„ìš© ì¦ê°€
- í•˜ì§€ë§Œ `msgid` ê¸°ë°˜ **ë©±ë“±ì„± ë³´ì¥**
- ë°ì´í„° ì •í•©ì„±ì—ëŠ” ë¬¸ì œ ì—†ìŒ

### Warehouse ì¸¡ (ì¹˜ëª…ì  ë¬¸ì œ)
- Redisì— OCR í…ìŠ¤íŠ¸ ì—†ìœ¼ë©´ **ë¬´í•œ retry**
- Warehouse ì´í›„ íŒŒì´í”„ë¼ì¸ **ì „ì²´ ì •ì§€**
- ì¬ê¸°ë™ ì‹œ Redis ë°ì´í„° ì˜ì†ì„± ë¯¸ë³´ì¥ â†’ íŒŒì´í”„ë¼ì¸ ê¼¬ì„ ê°€ëŠ¥

> ìš´ì˜ ê´€ì ì—ì„œ **Collector + Warehouse ëª¨ë‘ Redis ê³ ê°€ìš©ì„± í•„ìˆ˜**

---
<br>

## âš™ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë°©ë²• (Solution)
### 1ï¸âƒ£ Redis ê³ ê°€ìš©ì„± ì•„í‚¤í…ì²˜ ì„ íƒ
#### âœ” ì„ íƒì§€ ë¹„êµ
- Masterâ€“Slave + Sentinel
- Redis Cluster
#### âœ” ê²°ì •
- ì¶”í›„ í™•ì¥ì„± ê³ ë ¤ â†’ **Redis Cluster êµ¬ì¡° ì±„íƒ**
- ëª©í‘œ: 3 Master + 3 Slave êµ¬ì¡°
---

### 2ï¸âƒ£ Redis Cluster êµ¬ì„±
#### âœ” í´ëŸ¬ìŠ¤í„° êµ¬ì¡°
- ì´ 16384 ìŠ¬ë¡¯ ë¶„ì‚°
- ê° Masterì— Slave 1ê°œì”© ë°°ì¹˜
- ìë™ Failover ì§€ì›
```bash
Redis Cluster HA (3 ì„œë²„, 3 Master + 3 Slave)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì„œë²„ 192.169.122.59
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Master A                â”‚ Slot 0~5460
â”‚ ì»¨í…Œì´ë„ˆ: job_redis     â”‚ í¬íŠ¸: 6379
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Slave B (65ë²ˆ)          â”‚ ë³µì œ Master B
â”‚ ì»¨í…Œì´ë„ˆ: job_redis_slaveâ”‚ í¬íŠ¸: 6380
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì„œë²„ 192.169.122.65
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Master B                â”‚ Slot 5461~10922
â”‚ ì»¨í…Œì´ë„ˆ: job_redis     â”‚ í¬íŠ¸: 6379
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Slave C (64ë²ˆ)          â”‚ ë³µì œ Master C
â”‚ ì»¨í…Œì´ë„ˆ: job_redis_slaveâ”‚ í¬íŠ¸: 6380
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì„œë²„ 192.169.122.64
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Master C                â”‚ Slot 10923~16383
â”‚ ì»¨í…Œì´ë„ˆ: job_redis     â”‚ í¬íŠ¸: 6379
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Slave A (59ë²ˆ)          â”‚ ë³µì œ Master A
â”‚ ì»¨í…Œì´ë„ˆ: job_redis_slaveâ”‚ í¬íŠ¸: 6380
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
#### âœ” Docker ê¸°ë°˜ Redis ì‹¤í–‰
```bash
## Redis ( Master ) ##
docker run --name job_redis_master -d \
  -p 6379:6379 -p 16379:16379 \
  -v /Data_project_job/docker_image/redis/rd_data:/data \
  redis:7 \
  redis-server \
  --requirepass 1234 --masterauth 1234 \
  --cluster-enabled yes --cluster-node-timeout 5000 \
  --appendonly no --save 600 1 \
  --cluster-announce-ip 192.168.122.65 \
  --cluster-announce-port 6379 \
  --cluster-announce-bus-port 16379

## Redis ( Slave ) ##
docker run --name job_redis_slave -d \
  -p 6380:6379 -p 16380:16379 \
  -v /Data_project_job/docker_image/redis/rd_data_slave:/data \
  redis:7 \
  redis-server \
  --requirepass 1234 --masterauth 1234 \
  --cluster-enabled yes --cluster-node-timeout 5000 \
  --appendonly no --save 600 1 \
  --cluster-announce-ip 192.168.122.65 \
  --cluster-announce-port 6380 \
  --cluster-announce-bus-port 16380
```
#### âœ” í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”
```bash
redis-cli --cluster create \
  192.168.122.59:6379 \
  192.168.122.65:6379 \
  192.168.122.64:6379 \
  192.168.122.59:6380 \
  192.168.122.65:6380 \
  192.168.122.64:6380 \
  --cluster-replicas 1 -a 1234
```
---
### 3ï¸âƒ£ Redis í´ëŸ¬ìŠ¤í„° ë…¸ë“œ í™•ì¸
```bash
$ redis-cli -h 192.168.122.59 -p 6379 -a 1234 cluster nodes

# ================================
# Master Nodes
# ================================

818f83592305c08e2ac0ebc01968e00850a87529  192.168.122.59:6379  master (myself)
â””â”€ Slot: 0-5460
â””â”€ Status: connected

39da300df2395972b94ed9684d291e079c7172c9  192.168.122.65:6379  master
â””â”€ Slot: 5461-10922
â””â”€ Status: connected

63ef7cdfee900b976d770ed4c47c060670b16903  192.168.122.64:6379  master
â””â”€ Slot: 10923-16383
â””â”€ Status: connected


# ================================
# Slave Nodes
# ================================

14e13a5c71882c30a720268d118d8d38b43d9a57  192.168.122.65:6380  slave
â””â”€ Replica of: Master A (192.168.122.59:6379)
â””â”€ Status: connected

e231f93e2c3b0ab8da9df82244758366c1759a91  192.168.122.59:6380  slave
â””â”€ Replica of: Master C (192.168.122.64:6379)
â””â”€ Status: connected

e4d59d13c8be6ca3adaac9353fab2d46d6b5dbd9  192.168.122.64:6380  slave
â””â”€ Replica of: Master B (192.168.122.65:6379)
â””â”€ Status: connected
```
---
### 4ï¸âƒ£ íŒŒì´ì¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—°ë™ í…ŒìŠ¤íŠ¸
- Redis í™˜ê²½ ë³€ìˆ˜ ë° Hook ìˆ˜ì •
- Collector ì„œë¹„ìŠ¤ ì¬ê¸°ë™
```bash
systemctl start collector.service
```
#### âœ” ê²°ê³¼
- ìˆ˜ì§‘ ë°ì´í„°: **393ê±´**
- Redis key ê°œìˆ˜ì™€ Collector ë¡œê·¸ ì¼ì¹˜
- ì¬ê¸°ë™ ì‹œ ì „ëŸ‰ ìŠ¤í‚µ ì •ìƒ ë™ì‘
```makefile
ì„±ê³µ: 0 | ìŠ¤í‚µ: 393
```
---
### 5ï¸âƒ£ ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ (Failover)
#### âœ” í…ŒìŠ¤íŠ¸ ì ˆì°¨
1) Master ë…¸ë“œ ê°•ì œ ì¢…ë£Œ **( ì¥ì•  )**
```bash
docker stop job_redis_master
```
2) Slave ìë™ ìŠ¹ê²© í™•ì¸
```bash
# ================================
# 1. ê¸°ì¡´ Master ì¥ì•  ë°œìƒ
# ================================

[FAILED MASTER]
63ef7cdfee900b976d770ed4c47c060670b16903  192.168.122.64:6379  master,fail
â””â”€ Slot: 10923-16383
â””â”€ Status: âŒ disconnected


# ================================
# 2. Slave â†’ Master ìë™ ìŠ¹ê²© í™•ì¸
# ================================

$ redis-cli -h 192.168.122.59 -p 6379 -a 1234 cluster nodes

[PROMOTED MASTER]
e231f93e2c3b0ab8da9df82244758366c1759a91  192.168.122.59:6380  master
â””â”€ Slot: 10923-16383
â””â”€ Status: âœ… connected
```
3) Collector ì¬ê¸°ë™
```bash
systemctl start collector.service
```

#### âœ” ê²°ê³¼
- ìë™ Failover ì„±ê³µ
- ê¸°ì¡´ ë°ì´í„° ìœ ì§€
- Collector ì •ìƒ ìŠ¤í‚µ ë™ì‘
```makefile
ì„±ê³µ: 0 | ìŠ¤í‚µ: 393 â†’ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ ì—†ìŒ
```

---
<br><br>

# ğŸ“Š ê²°ê³¼ (Result)

| ì§€í‘œ           | ë‹¨ì¼ Redis | Redis Cluster HA |
| ------------ | -------- | ---------------- |
| **ì¥ì•  ë³µêµ¬**    | ìˆ˜ë™ ëŒ€ì‘    | ìë™ Failover      |
| **ë°ì´í„° ì•ˆì •ì„±**  | ë‚®ìŒ       | ë†’ìŒ               |
| **íŒŒì´í”„ë¼ì¸ ì˜í–¥** | ì „ì²´ ì¤‘ë‹¨    | ì •ìƒ ìœ ì§€            |
| **í™•ì¥ì„±**      | ì œí•œì       | ìˆ˜í‰ í™•ì¥ ê°€ëŠ¥         |
| **ìš´ì˜ ì•ˆì •ì„±**   | ë‚®ìŒ       | ë§¤ìš° ë†’ìŒ            |

---

## âš¡ ì¥ì 
- Redis ì¥ì•  ì‹œ **ìë™ Failover**
- Warehouse ë¬´í•œ retry ë¬¸ì œ í•´ê²°
- íŒŒì´í”„ë¼ì¸ ì „ì²´ ì •ì§€ ë°©ì§€
- Redis Cluster ìˆ˜í‰ í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°
---
## âš¡ ë‹¨ì  / ê³ ë ¤ ì‚¬í•­
- ìš´ì˜ ë³µì¡ë„ ì¦ê°€
- í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§ í•„ìš”

---
<br><br>

# ğŸ† ì„±ê³¼ ìš”ì•½
| ì§€í‘œ            | ê¸°ì¡´    | ê°œì„          |
| ------------- | ----- | ---------- |
| **Redis êµ¬ì¡°**  | ë‹¨ì¼ ë…¸ë“œ | Cluster HA |
| **ì¥ì•  ëŒ€ì‘**     | ìˆ˜ë™    | ìë™         |
| **íŒŒì´í”„ë¼ì¸ ì•ˆì •ì„±** | ë¶ˆì•ˆì •   | ì•ˆì •         |
| **í™•ì¥ ë°©ì‹**     | ì œí•œì    | Scale-Out  |

---

## ğŸ“Œ ê²°ë¡ 
- RedisëŠ” íŒŒì´í”„ë¼ì¸ í•µì‹¬ êµ¬ì„±ìš”ì†Œ
- ë‹¨ì¼ ë…¸ë“œ êµ¬ì¡°ëŠ” ìš´ì˜ ë¦¬ìŠ¤í¬ í¼
- Redis Cluster ë„ì…ìœ¼ë¡œ ìë™ Failover í™•ë³´
- Collector / Warehouse ì•ˆì •ì„± í™•ë³´

---

## âœ… ìµœì¢… ì„ íƒ
- Redis Cluster (3 Master + 3 Slave)
- ìë™ Failover ê¸°ë°˜ ê³ ê°€ìš©ì„±
---
